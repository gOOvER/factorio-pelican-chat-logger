name: Create Factorio Mod Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Validate version format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format X.Y.Z (e.g., 1.0.0)"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Shallow clone, no git history needed
          fetch-depth: 1

      - name: Update info.json version
        run: |
          # Update the version in info.json
          jq '.version = "${{ inputs.version }}"' info.json > info.json.tmp
          mv info.json.tmp info.json
          
          # Show the updated file
          echo "Updated info.json:"
          cat info.json

      - name: Create Factorio mod package
        run: |
          # Factorio mod naming standard: modname_version
          MOD_NAME="pelican-chat-logger"
          MOD_VERSION="${{ inputs.version }}"
          MOD_FOLDER="${MOD_NAME}_${MOD_VERSION}"
          
          # Create clean mod folder
          mkdir -p "${MOD_FOLDER}"
          
          # Copy ONLY required mod files
          cp info.json "${MOD_FOLDER}/"
          cp control.lua "${MOD_FOLDER}/"
          cp -r locale "${MOD_FOLDER}/"
          
          # Optional: thumbnail for mod portal (keep small!)
          if [ -f thumbnail.png ]; then
            # Check thumbnail size (should be < 1MB)
            THUMB_SIZE=$(stat -c%s "thumbnail.png")
            if [ "$THUMB_SIZE" -lt 1048576 ]; then
              cp thumbnail.png "${MOD_FOLDER}/"
            else
              echo "WARNING: thumbnail.png too large ($THUMB_SIZE bytes), skipping"
            fi
          fi
          
          # Show folder structure
          echo "=== Mod folder contents ==="
          find "${MOD_FOLDER}" -type f -exec ls -lh {} \;
          
          # Calculate folder size
          FOLDER_SIZE=$(du -sh "${MOD_FOLDER}" | cut -f1)
          echo ""
          echo "Total folder size: ${FOLDER_SIZE}"
          
          # Create ZIP (without compression artifacts)
          cd "${MOD_FOLDER}"
          zip -r "../${MOD_FOLDER}.zip" .
          cd ..
          
          # Wrap in correct folder structure for Factorio
          rm -rf "${MOD_FOLDER}"
          mkdir "${MOD_FOLDER}"
          cd "${MOD_FOLDER}"
          unzip "../${MOD_FOLDER}.zip"
          cd ..
          rm "${MOD_FOLDER}.zip"
          zip -r "${MOD_FOLDER}.zip" "${MOD_FOLDER}"
          
          # Verify ZIP
          echo ""
          echo "=== ZIP Contents ==="
          unzip -l "${MOD_FOLDER}.zip"
          
          # Check ZIP size
          ZIP_SIZE=$(stat -c%s "${MOD_FOLDER}.zip")
          ZIP_SIZE_KB=$((ZIP_SIZE / 1024))
          echo ""
          echo "=== ZIP size: ${ZIP_SIZE_KB} KB ==="
          
          # Warn if ZIP is suspiciously large (> 100KB for this mod)
          if [ "$ZIP_SIZE" -gt 102400 ]; then
            echo "WARNING: ZIP is larger than expected (${ZIP_SIZE_KB} KB)"
            echo "Expected < 100 KB for this mod"
          fi
          
          # Verify structure
          echo ""
          echo "=== Verifying ZIP structure ==="
          FIRST_ENTRY=$(unzip -l "${MOD_FOLDER}.zip" | grep -m1 "info.json" | awk '{print $4}')
          if [[ "$FIRST_ENTRY" == "${MOD_FOLDER}/info.json" ]]; then
            echo "✓ ZIP structure is correct: ${FIRST_ENTRY}"
          else
            echo "✗ ERROR: ZIP structure is incorrect!"
            echo "  Expected: ${MOD_FOLDER}/info.json"
            echo "  Got: ${FIRST_ENTRY}"
            exit 1
          fi

      - name: Extract release notes from CHANGELOG
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            # Extract notes for the current version
            NOTES=$(awk '/^## \[?v?${{ inputs.version }}\]?/{flag=1; next} /^## \[?v?[0-9]/{flag=0} flag' CHANGELOG.md)
            if [ -z "$NOTES" ]; then
              NOTES="Release version ${{ inputs.version }}"
            fi
          else
            NOTES="Release version ${{ inputs.version }}"
          fi
          
          # Save to file to handle multi-line content
          echo "$NOTES" > release_notes.txt
          echo "notes_file=release_notes.txt" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.version }}
          name: "Pelican Chat Logger v${{ inputs.version }}"
          body_path: ${{ steps.changelog.outputs.notes_file }}
          files: |
            pelican-chat-logger_${{ inputs.version }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
