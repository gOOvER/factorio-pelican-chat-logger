name: Create Factorio Mod Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Validate version format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format X.Y.Z (e.g., 1.0.0)"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update info.json version
        run: |
          # Update the version in info.json
          jq '.version = "${{ inputs.version }}"' info.json > info.json.tmp
          mv info.json.tmp info.json
          
          # Show the updated file
          echo "Updated info.json:"
          cat info.json

      - name: Create Factorio mod package
        run: |
          # Factorio mod naming standard: modname_version
          MOD_NAME="pelican-chat-logger"
          MOD_VERSION="${{ inputs.version }}"
          MOD_FOLDER="${MOD_NAME}_${MOD_VERSION}"
          
          # Create the mod folder structure
          mkdir -p "${MOD_FOLDER}"
          
          # Copy all mod files (excluding .git and .github)
          cp info.json "${MOD_FOLDER}/"
          cp control.lua "${MOD_FOLDER}/"
          cp -r locale "${MOD_FOLDER}/"
          
          # Copy optional files if they exist
          [ -f README.md ] && cp README.md "${MOD_FOLDER}/"
          [ -f LICENSE ] && cp LICENSE "${MOD_FOLDER}/"
          [ -f CHANGELOG.md ] && cp CHANGELOG.md "${MOD_FOLDER}/"
          [ -f changelog.txt ] && cp changelog.txt "${MOD_FOLDER}/"
          [ -f thumbnail.png ] && cp thumbnail.png "${MOD_FOLDER}/"
          
          # Verify the folder structure
          echo "=== Folder structure ==="
          find "${MOD_FOLDER}" -type f
          
          # Create the ZIP file (Factorio standard format)
          # Using -r to recurse and preserve folder structure
          zip -r "${MOD_FOLDER}.zip" "${MOD_FOLDER}"
          
          echo ""
          echo "=== Created: ${MOD_FOLDER}.zip ==="
          echo "=== ZIP Contents ==="
          unzip -l "${MOD_FOLDER}.zip"
          
          # Verify ZIP structure is correct (should have modname_version/ as root)
          echo ""
          echo "=== Verifying ZIP structure ==="
          FIRST_ENTRY=$(unzip -l "${MOD_FOLDER}.zip" | grep -m1 "info.json" | awk '{print $4}')
          if [[ "$FIRST_ENTRY" == "${MOD_FOLDER}/info.json" ]]; then
            echo "✓ ZIP structure is correct: ${FIRST_ENTRY}"
          else
            echo "✗ ERROR: ZIP structure is incorrect!"
            echo "  Expected: ${MOD_FOLDER}/info.json"
            echo "  Got: ${FIRST_ENTRY}"
            exit 1
          fi

      - name: Extract release notes from CHANGELOG
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            # Extract notes for the current version
            NOTES=$(awk '/^## \[?v?${{ inputs.version }}\]?/{flag=1; next} /^## \[?v?[0-9]/{flag=0} flag' CHANGELOG.md)
            if [ -z "$NOTES" ]; then
              NOTES="Release version ${{ inputs.version }}"
            fi
          else
            NOTES="Release version ${{ inputs.version }}"
          fi
          
          # Save to file to handle multi-line content
          echo "$NOTES" > release_notes.txt
          echo "notes_file=release_notes.txt" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.version }}
          name: "Pelican Chat Logger v${{ inputs.version }}"
          body_path: ${{ steps.changelog.outputs.notes_file }}
          files: |
            pelican-chat-logger_${{ inputs.version }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
